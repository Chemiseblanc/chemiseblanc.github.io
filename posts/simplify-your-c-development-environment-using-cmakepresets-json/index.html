<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="#eeeeee" media="(prefers-color-scheme: light)"><meta name=theme-color content="#333333" media="(prefers-color-scheme: dark)"><meta name=description content="CMake is a cross-platform utility that abstracts your C++ projects across a wide array of operating systems, compiler toolchains, and build tools. While supported by popular editors such as Visual Studio, VSCode, and CLion, there hasn’t been any way to specify build variants and toolchain options in a cross-editor fashion."><meta name=apple-mobile-web-app-capable content="yes"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=theme-color content="#ffffff"><link rel=preload href=/style.min.css as=style><link rel=stylesheet type=text/css href=/style.min.css><link rel=preload href=/css/icons.min.css as=style><link rel=stylesheet type=text/css href=/css/icons.min.css><title>Matt's Homepage | Simplify your C++ development environment using CMakePresets.json</title></head><body><main class="content single"><div class=tags><a href=https://mgibson.ca/tags/c++/>#c++</a>
<a href=https://mgibson.ca/tags/cmake/>#cmake</a></div><article><header><h1>Simplify your C++ development environment using CMakePresets.json</h1><p class=byline>Published on: <time>Sep 16, 2022</time></p></header><p>CMake is a cross-platform utility that abstracts your C++ projects across a wide array of operating systems, compiler toolchains, and build tools. While supported by popular editors such as Visual Studio, VSCode, and CLion, there hasn’t been any way to specify build variants and toolchain options in a cross-editor fashion.</p><p>Build variants is the collection of the all the different ways your project can be built. This includes Debug/Release builds, builds with various compile-time options enabled or disabled, and builds with different compiler toolchains, whether that be for Windows, Mac, Linux, Mobile, or Embedded platforms.</p><p>Normally each variant needs to be configured using a set of options passed to CMake during the configuration step, or through an editor specific means of configuration such as cmake-variants.json for VSCode or CMake profiles in CLion. Having these different formats adds an additional point where consistency has to be ensured in a code base to make sure that for example, a debug build on Linux using GCC is compiled with the same options as a debug build on windows using MSVC.</p><p>Starting with CMake 3.19 (released November 2020) a new feature called CMake Presets has been added to describe CMake configuration options in a universal way. This makes it easier to maintain consistent build configurations across different developer setups and CI/CD pipelines.</p><p>You can use CMake presets by creating a file named CMakePresets.json in your project root directory. The basic format for this file is:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;version&#34;</span>: <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;cmakeMinimumRequired&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;major&#34;</span>: <span style=color:#ae81ff>3</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;minor&#34;</span>: <span style=color:#ae81ff>20</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;patch&#34;</span>: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;configurePresets&#34;</span>: [
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>From my experience testing, using version 2 of the schema has the best compatibility across multiple editors as of this writing (September 2022).</p><p>To define a preset within the <em>configurePresets</em> array we create a json object with the following format</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;preset-name&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;displayName&#34;</span>: <span style=color:#e6db74>&#34;Pretty name for editor GUI&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;description&#34;</span>: <span style=color:#e6db74>&#34;Tooltip for editor&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;generator&#34;</span>: <span style=color:#e6db74>&#34;Name of build system to generate for, argument to -G flag of cmake command&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;binaryDir&#34;</span>: <span style=color:#e6db74>&#34;build directory, can use ${sourceDir} to specify it as relative to project root directory&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;cacheVariables&#34;</span>: {
</span></span><span style=display:flex><span>     <span style=color:#f92672>&#34;CACHE_VAR1&#34;</span>: <span style=color:#e6db74>&#34;equivalent to -DCACHE_VAR1=&#34;</span>,
</span></span><span style=display:flex><span>     <span style=color:#f92672>&#34;CACHE_VAR2&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;STRING&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;value&#34;</span>: <span style=color:#e6db74>&#34;equivalent to -DCACHE_VAR2:STRING=&#34;</span>
</span></span><span style=display:flex><span>     }
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;environment&#34;</span>: {
</span></span><span style=display:flex><span>     <span style=color:#f92672>&#34;ENV_VAR1&#34;</span>: <span style=color:#e6db74>&#34;same format as the cache variable entries&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}  
</span></span></code></pre></div><p>The variables for a preset map directly to the arguments that would have previously been passed to the cmake command.</p><p>To use a preset from the command line, pass the –prefix=prefix-name argument to the cmake command. Any other arguments passed will override conflicting variables in the preset. As an example:</p><p>Before:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mkdir build <span style=color:#f92672>&amp;&amp;</span> cd build <span style=color:#f92672>&amp;&amp;</span> cmake .. -GNinja -DCMAKE_BUILD_TYPE<span style=color:#f92672>=</span>RelWithDebInfo -DBUILD_TESTING<span style=color:#f92672>=</span>ON
</span></span></code></pre></div><p>A﻿fter:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>cmake . --preset<span style=color:#f92672>=</span>preset-name
</span></span></code></pre></div><p>If you’re using an editor that supports presets, all you need to do is open the project and it will handle everything for you.</p><p>Now you’ve seen how to create a CMakePresets.json file and define basic presets. But what about for projects with more complicated feature matrices?</p><p>With the basic pattern presented before, you would need to define one preset for each combination of your build options, which introduces the need to ensure consistency for the feature options across every preset with it enabled. It would be nice to encapsulate the options specific to each feature in a reusable manner which we can do using preset inheritance.</p><p>As an example, if we have a feature matrix along two axis of build type, and c++ compiler we end up with N + M feature presets followed by one preset for each allowed state of the feature matrix.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;version&#34;</span>: <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;cmakeMinimumRequired&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;major&#34;</span>: <span style=color:#ae81ff>3</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;minor&#34;</span>: <span style=color:#ae81ff>20</span>,
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;patch&#34;</span>: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;configurePresets&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;core&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;hidden&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;generator&#34;</span>: <span style=color:#e6db74>&#34;Ninja&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;binaryDir&#34;</span>: <span style=color:#e6db74>&#34;${sourceDir}/out/build/${presetName}&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;installDir&#34;</span>: <span style=color:#e6db74>&#34;${sourceDir}/out/install/${presetName}&#34;</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;debug&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;hidden&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;cacheVariables&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;CMAKE_BUILD_TYPE&#34;</span>: <span style=color:#e6db74>&#34;Debug&#34;</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;release&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;hidden&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;cacheVariables&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;CMAKE_BUILD_TYPE&#34;</span>: <span style=color:#e6db74>&#34;Release&#34;</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;msvc&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;hidden&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;cacheVariables&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;CMAKE_CXX_COMPILER&#34;</span>: <span style=color:#e6db74>&#34;cl.exe&#34;</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;gcc&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;hidden&#34;</span>: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;cacheVariables&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;CMAKE_CXX_COMPILER&#34;</span>: <span style=color:#e6db74>&#34;g++&#34;</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;debug-msvc&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;displayName&#34;</span>: <span style=color:#e6db74>&#34;Debug (MSVC)&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;inherits&#34;</span>: [
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;core&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;debug&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;msvc&#34;</span>
</span></span><span style=display:flex><span>            ]
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;debug-gcc&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;displayName&#34;</span>: <span style=color:#e6db74>&#34;Debug (GCC)&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;inherits&#34;</span>: [
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;core&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;debug&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;gcc&#34;</span>
</span></span><span style=display:flex><span>            ]
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;release-msvc&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;displayName&#34;</span>: <span style=color:#e6db74>&#34;Debug (MSVC)&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;inherits&#34;</span>: [
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;core&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;release&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;msvc&#34;</span>
</span></span><span style=display:flex><span>            ]
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;release-gcc&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;displayName&#34;</span>: <span style=color:#e6db74>&#34;Debug (GCC)&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;inherits&#34;</span>: [
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;core&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;release&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;gcc&#34;</span>
</span></span><span style=display:flex><span>            ]
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Using this strategy for presets makes it easier to incorporate into CI/CD matrix builds since the preset name can be templated to have a command like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>PRESET<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>feature-axis-1<span style=color:#e6db74>}</span><span style=color:#e6db74>-</span><span style=color:#e6db74>${</span>feature-axis-2<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>cmake . --preset<span style=color:#f92672>=</span>$PRESET <span style=color:#f92672>&amp;&amp;</span> cmake --build --preset<span style=color:#f92672>=</span>$PRESET
</span></span></code></pre></div><p>Presets are a relatively new feature and their capabilities are still evolving so in time there may be better approaches for handling large feature matrices, but for now you can still use presets to simplify your cross platform project configuration needs and get one step closer to having robust, parametric builds for your software projects.</p><p>For a full specification of the CMakePresets.json format and allowed properties check the official documentation here: <a href=https://cmake.org/cmake/help/latest/manual/cmake-presets.7.html>https://cmake.org/cmake/help/latest/manual/cmake-presets.7.html</a></p><a class=section-link href=https://mgibson.ca/posts/>See more in Posts</a></article></main></body></html>