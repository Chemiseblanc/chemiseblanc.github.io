<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=theme-color content="#eeeeee" media="(prefers-color-scheme: light)"><meta name=theme-color content="#333333" media="(prefers-color-scheme: dark)"><meta name=description content="When using vcpkg on projects with many or large dependencies, a large portion of your total build time can be just from building these dependencies even though the resulting artifacts don&rsquo;t change between compiles."><meta name=apple-mobile-web-app-capable content="yes"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=theme-color content="#ffffff"><link rel=preload href=/style.min.css as=style><link rel=stylesheet type=text/css href=/style.min.css><link rel=preload href=/css/icons.min.css as=style><link rel=stylesheet type=text/css href=/css/icons.min.css><title>Matt's Homepage | VCPKG Binary Caching with Nuget</title></head><body><main class="content single"><div class=tags><a href=https://mgibson.ca/tags/vcpkg/>#Vcpkg</a></div><article><header><h1>VCPKG Binary Caching with Nuget</h1><p class=byline>Published on: <time>Dec 22, 2022</time></p></header><p>When using vcpkg on projects with many or large dependencies, a large portion of your total build time can be just from building these dependencies even though the resulting artifacts don&rsquo;t change between compiles.
On a local development environment this is usually an upfront time cost as vcpkg will by default save the artifacts to a local per-user cache but for CI environments you don&rsquo;t necessarily have the persistant storage of this cache between runs.</p><p>To address this there is support for using alternative caching solutions. Using these caching solutions also lets developers more easily work from multiple machines since there is no longer a per-machine cost for compiling dependencies.</p><p>The official documentation for binary caching can be found here: <a href=https://learn.microsoft.com/en-us/vcpkg/users/binarycaching>https://learn.microsoft.com/en-us/vcpkg/users/binarycaching</a>
For this example we will use a self hosted NuGet repository hosted using the new package registry support on Gitea. The same steps apply for any other platform offering NuGet hosting.</p><p>The first step is to add the registry to NuGet. On Linux systems this requires mono to be installed.
What we need is the URL for the NuGet feed and credentials to access the system.
For a CI system the hardcoded application token can be replaced by whatever means you use for secrets management.
We use &lsquo;vcpkg fetch&rsquo; to handle installing a repository-local copy of nuget with a version supported by vcpkg.
If you have an appropriate version of nuget already installed then this can be replaced with the normal nuget command.</p><p>P﻿owershell:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>SOURCE=Gitea
</span></span><span style=display:flex><span>USERNAME=john_doe
</span></span><span style=display:flex><span>PASS=pam_token
</span></span><span style=display:flex><span>SOURCE_URL=https<span style=color:#960050;background-color:#1e0010>:</span>//&lt;gitea_url&gt;/api/packages/$USERNAME/nuget/index.json
</span></span><span style=display:flex><span>&amp; $(vcpkg fetch nuget) add source --name $SOURCE --username $USERNAME --password $PASS $SOURCE_URL
</span></span></code></pre></div><p>B﻿ash:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>SOURCE<span style=color:#f92672>=</span>Gitea
</span></span><span style=display:flex><span>USERNAME<span style=color:#f92672>=</span>john_doe
</span></span><span style=display:flex><span>PASS<span style=color:#f92672>=</span>pam_token
</span></span><span style=display:flex><span>SOURCE_URL<span style=color:#f92672>=</span>https://&lt;gitea_url&gt;/api/packages/$USERNAME/nuget/index.json
</span></span><span style=display:flex><span>mono <span style=color:#66d9ef>$(</span>vcpkg fetch nuget | tail -n 1<span style=color:#66d9ef>)</span> add source --name $NAME --username $USERNAME --password $PASS $SOURCE_URL
</span></span></code></pre></div><p>Now that the repository has been added to NuGet we can set the environment variable VCPKG_BINARY_SOURCES to use this cache.</p><p>P﻿owershell:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>[<span style=color:#66d9ef>Environment</span>]::SetEnvironmentVariable(<span style=color:#e6db74>&#34;VCPKG_BINARY_SOURCES&#34;</span>, <span style=color:#e6db74>&#34;nuget,</span>$SOURCE<span style=color:#e6db74>,readwrite&#34;</span>, [EnvironmentVariableTarget::User])
</span></span></code></pre></div><p>B﻿ash:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>echo <span style=color:#e6db74>&#34;export VCPKG_BINARY_SOURCES=nuget,</span>$SOURCE<span style=color:#e6db74>,readwrite&#34;</span> &gt;&gt; ~/.bashrc
</span></span></code></pre></div><p>If you want to completely disable the local caching, you can prepend &lsquo;clear;&rsquo; to the start of the configuration string.</p><p>Now if you install some package, it will first check the registry to see if the binaries are already available, and if they aren&rsquo;t it will download and compile it on your local machine and then upload the binaries for future use.</p><p>Additional Notes:
If you are self-hosting a NuGet repository behind a proxy, you might need to adjust your proxy&rsquo;s max body size to allow for uploading large artifacts.
For nginx this can be set with the parameter client_max_body_size.</p><a class=section-link href=https://mgibson.ca/posts/>See more in Posts</a></article></main></body></html>